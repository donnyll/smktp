<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Co-Curricular Achievement Management</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-title">Co-Curricular</div>
        <div class="brand-sub">Achievement System</div>
      </div>

      <div id="user-badge" class="user-badge hidden">
        <div id="user-email" class="user-email"></div>
        <div id="user-role" class="pill"></div>
      </div>

      <nav class="nav">
        <button id="nav-login" class="nav-btn" data-nav="login">Login</button>
        <button id="nav-admin" class="nav-btn requires-auth hidden" data-nav="admin">Admin</button>
        <button id="nav-teacher" class="nav-btn requires-auth hidden" data-nav="teacher">Teacher</button>
      </nav>

      <div class="sidebar-footer">
        <button id="btn-logout" class="btn danger requires-auth hidden">Logout</button>
        <div class="hint">
          Static SPA (Vercel-ready)<br/>
          Supabase Auth + RLS
        </div>
      </div>
    </aside>

    <main class="main">
      <div id="unauthorized" class="alert hidden"></div>

      <!-- LOGIN VIEW -->
      <section id="view-login" class="view">
        <h1>Sign in</h1>
        <p class="muted">Use your teacher/admin account to access the system.</p>

        <div class="card">
          <form id="form-login" class="form">
            <div class="field">
              <label for="login-email">Email</label>
              <input id="login-email" type="email" autocomplete="email" required placeholder="teacher@school.com" />
            </div>

            <div class="field">
              <label for="login-password">Password</label>
              <input id="login-password" type="password" autocomplete="current-password" required placeholder="••••••••" />
            </div>

            <div class="row">
              <button class="btn primary" type="submit">Login</button>
              <button class="btn secondary" type="button" id="btn-go-signup">Create teacher</button>
            </div>

            <div class="muted small">
              Admin access is enforced by <b>database RLS</b> (not just UI).
            </div>
          </form>
        </div>

        <div id="signup-panel" class="card hidden">
          <h2>Create Teacher Account</h2>
          <p class="muted small">
            This creates a teacher user (default role: teacher). To create an admin, promote the user in Supabase SQL Editor.
          </p>

          <form id="form-signup" class="form">
            <div class="field">
              <label for="signup-email">Email</label>
              <input id="signup-email" type="email" autocomplete="email" required placeholder="newteacher@school.com" />
            </div>

            <div class="field">
              <label for="signup-password">Password</label>
              <input id="signup-password" type="password" autocomplete="new-password" required minlength="6" placeholder="min 6 chars" />
            </div>

            <div class="row">
              <button class="btn primary" type="submit">Sign up</button>
              <button class="btn secondary" type="button" id="btn-cancel-signup">Cancel</button>
            </div>
          </form>
        </div>
      </section>

      <!-- ADMIN VIEW -->
      <section id="view-admin" class="view hidden">
        <div class="view-header">
          <div class="row space-between align-center">
            <div>
              <h1>Admin Console</h1>
              <div class="muted">Manage Classes, Students, and Co-curricular Types.</div>
            </div>
            <button id="btn-export-admin" class="btn secondary">Export CSV (All)</button>
          </div>
        </div>

        <div class="grid-2">
          <!-- Classes -->
          <div class="card">
            <div class="card-header">
              <h2>Class Management</h2>
              <div class="row wrap">
                <div class="field-inline">
                  <label for="admin-grade-select">Grade</label>
                  <select id="admin-grade-select"></select>
                </div>
                <button id="btn-class-create" class="btn primary">+ New Class</button>
              </div>
            </div>

            <table class="table" id="tbl-classes">
              <thead>
                <tr>
                  <th>Class</th>
                  <th>Grade</th>
                  <th class="right">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <div class="muted small">
              Tip: Deleting a class will also delete its students and their entries (cascade).
            </div>
          </div>

          <!-- Students -->
          <div class="card">
            <div class="card-header">
              <h2>Student Management</h2>
              <div class="row wrap">
                <div class="field-inline">
                  <label for="admin-class-select">Class</label>
                  <select id="admin-class-select"></select>
                </div>
                <button id="btn-student-create" class="btn primary">+ New Student</button>
              </div>
            </div>

            <table class="table" id="tbl-students">
              <thead>
                <tr>
                  <th>Student</th>
                  <th>Student No</th>
                  <th class="right">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Types -->
        <div class="card">
          <div class="card-header">
            <h2>Co-curricular Types</h2>
            <div class="row">
              <button id="btn-type-create" class="btn primary">+ New Type</button>
            </div>
          </div>

          <table class="table" id="tbl-types">
            <thead>
              <tr>
                <th>Type Name</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="muted small">
            Deleting a type may fail if entries already reference it (restricted).
          </div>
        </div>
      </section>

      <!-- TEACHER VIEW -->
      <section id="view-teacher" class="view hidden">
        <div class="view-header">
          <div class="row space-between align-center">
            <div>
              <h1>Teacher</h1>
              <div class="muted">Select grade → class → student, then record achievements.</div>
            </div>
            <button id="btn-export-teacher" class="btn secondary">Export CSV (All)</button>
          </div>
        </div>

        <div class="card">
          <div class="row wrap">
            <div class="field-inline">
              <label for="teacher-grade-select">Grade</label>
              <select id="teacher-grade-select"></select>
            </div>

            <div class="field-inline">
              <label for="teacher-class-select">Class</label>
              <select id="teacher-class-select" disabled></select>
            </div>

            <div class="field-inline grow">
              <label for="student-search">Search</label>
              <input id="student-search" type="text" placeholder="Type student name..." />
            </div>
          </div>

          <table class="table" id="tbl-teacher-students">
            <thead>
              <tr>
                <th>Student</th>
                <th>Student No</th>
                <th class="right">Open</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- STUDENT DETAIL VIEW -->
      <section id="view-student-detail" class="view hidden">
        <div class="row space-between align-center">
          <div>
            <h1 id="student-detail-title">Student</h1>
            <div id="student-detail-sub" class="muted"></div>
          </div>
          <div class="row">
            <button id="btn-export-student" class="btn secondary">Export CSV (Student)</button>
            <button id="btn-back-teacher" class="btn secondary">← Back</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Add Co-Curricular Entry</h2>
            <div class="muted small">Subject min 3 chars • Date required • Type required</div>
          </div>

          <form id="form-entry" class="form">
            <div class="grid-3">
              <div class="field">
                <label for="entry-subject">Subject</label>
                <input id="entry-subject" type="text" minlength="3" required placeholder="e.g., Badminton Training" />
              </div>
              <div class="field">
                <label for="entry-date">Activity Date</label>
                <input id="entry-date" type="date" required />
              </div>
              <div class="field">
                <label for="entry-type">Type</label>
                <select id="entry-type" required></select>
              </div>
            </div>
            <div class="row">
              <button class="btn primary" type="submit">Save Entry</button>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>History</h2>
          </div>

          <table class="table" id="tbl-entries">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Subject</th>
                <th>Created</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Toasts + loading -->
  <div id="toast-container"></div>
  <div id="loading-overlay" class="hidden">
    <div class="loading-card">
      <div class="spinner"></div>
      <div>Loading…</div>
    </div>
  </div>

  <!-- Modal (dialog) -->
  <dialog id="modal">
    <form id="modal-form" method="dialog">
      <h3 id="modal-title"></h3>
      <div id="modal-body" class="modal-body"></div>
      <div class="row right">
        <button type="button" id="modal-cancel" class="btn secondary">Cancel</button>
        <button type="submit" id="modal-submit" class="btn primary">Save</button>
      </div>
    </form>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="app.js"></script>
</body>
</html>
